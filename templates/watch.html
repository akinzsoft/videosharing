<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Custom Video Player</title>
  <style>
    body {
      background: #111;
      font-family: Arial, sans-serif;
      color: white;
      margin: 0;
      padding: 20px;
    }

    .video-container {
      max-width: 800px;
      margin: 0 auto;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }

    video {
      width: 100%;
      height: auto;
      background: #000;
    }

    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(0,0,0,0.6);
      padding: 10px;
    }

    .btn {
      background: none;
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
    }

    .progress {
      flex-grow: 1;
      height: 6px;
      background: #333;
      margin: 0 10px;
      cursor: pointer;
      position: relative;
      border-radius: 3px;
    }

    .progress-filled {
      background: #2ecc40;
      height: 100%;
      width: 0%;
      border-radius: 3px;
    }

    .time {
      font-size: 14px;
      white-space: nowrap;
    }

    .feedback {
      max-width: 800px;
      margin: 30px auto 0;
    }

    textarea {
      width: 100%;
      height: 80px;
      border-radius: 6px;
      padding: 10px;
      resize: vertical;
    }

    .rating {
      display: flex;
      flex-direction: row-reverse;
      justify-content: flex-start;
      gap: 5px;
      margin: 10px 0;
    }

    .rating input {
      display: none;
    }

    .rating label {
      font-size: 24px;
      cursor: pointer;
      color: #444;
    }

    .rating input:checked ~ label,
    .rating label:hover,
    .rating label:hover ~ label {
      color: #2ecc40;
    }

    button.submit {
      background: #2ecc40;
      color: white;
      padding: 10px 20px;
      border: none;
      margin-top: 10px;
      border-radius: 5px;
      cursor: pointer;
    }

    .comments {
      margin-top: 20px;
    }

    .comment-item {
      background: #222;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .stars {
      color: #2ecc40;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>

  <div class="video-container">
    <video id="video" preload="metadata"></video>
    
    <div class="controls">
      <button id="playPause" class="btn">▶</button>
      <div class="progress" id="progress">
        <div class="progress-filled" id="progressFilled"></div>
      </div>
      <div class="time"><span id="current">0:00</span> / <span id="duration">0:00</span></div>
      <button id="fullscreen" class="btn">⛶</button>
    </div>
  </div>

  <div class="feedback">
    <h2>Leave a Comment & Rating</h2>
    <form id="feedbackForm">
          {% csrf_token %}
      <textarea id="mesg" required placeholder="Write your comment..."></textarea>
      <div class="rating">
        <input type="radio" name="rating" id="star5" value="5"><label for="star5">★</label>
        <input type="radio" name="rating" id="star4" value="4"><label for="star4">★</label>
        <input type="radio" name="rating" id="star3" value="3"><label for="star3">★</label>
        <input type="radio" name="rating" id="star2" value="2"><label for="star2">★</label>
        <input type="radio" name="rating" id="star1" value="1"><label for="star1">★</label>
      </div>
      <button type="submit" id="submit" class="submit">Submit</button>
    </form>

    <div class="comments" id="commentsList">
      <h3>Comments</h3>
      <!-- Comments appear here -->
    </div>
  </div>

  <script>
    // --- Load video from URL param ---
    const params = new URLSearchParams(window.location.search);
    const videoId = params.get('id');
    const video = document.getElementById('video');

    if (videoId) {
      video.src = videoId;
    } else {
      alert("No video ID provided in URL.");
    }

    // --- Controls ---
    const playPause = document.getElementById('playPause');
    const progress = document.getElementById('progress');
    const progressFilled = document.getElementById('progressFilled');
    const current = document.getElementById('current');
    const duration = document.getElementById('duration');
    const fullscreenBtn = document.getElementById('fullscreen');

    let isPlaying = false;

    playPause.addEventListener('click', () => {
      if (video.paused) {
        video.play();
      } else {
        video.pause();
      }
    });

    video.addEventListener('play', () => {
      playPause.textContent = '⏸';
      isPlaying = true;
    });

    video.addEventListener('pause', () => {
      playPause.textContent = '▶';
      isPlaying = false;
    });

    video.addEventListener('timeupdate', () => {
      const percent = (video.currentTime / video.duration) * 100;
      progressFilled.style.width = percent + '%';
      current.textContent = formatTime(video.currentTime);
    });

    video.addEventListener('loadedmetadata', () => {
      duration.textContent = formatTime(video.duration);
    });

    progress.addEventListener('click', (e) => {
      const rect = progress.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const width = rect.width;
      const time = (clickX / width) * video.duration;
      video.currentTime = time;
    });

    fullscreenBtn.addEventListener('click', () => {
      if (!document.fullscreenElement) {
        video.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    });

    function formatTime(seconds) {
      const min = Math.floor(seconds / 60);
      const sec = Math.floor(seconds % 60).toString().padStart(2, '0');
      return `${min}:${sec}`;
    }

    // --- Comment & Rating ---
    const form = document.getElementById('feedbackForm');
    const commentsList = document.getElementById('commentsList');

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const comment = document.getElementById('comment').value.trim();
      const rating = document.querySelector('input[name="rating"]:checked');

      if (!rating) {
        alert("Please select a rating.");
        return;
      }

      const commentDiv = document.createElement('div');
      commentDiv.className = 'comment-item';

      const starsDiv = document.createElement('div');
      starsDiv.className = 'stars';
      starsDiv.textContent = '★'.repeat(rating.value) + '☆'.repeat(5 - rating.value);

      const text = document.createElement('p');
      text.textContent = comment;

      commentDiv.appendChild(starsDiv);
      commentDiv.appendChild(text);
      commentsList.appendChild(commentDiv);

      form.reset();
    });
  </script>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
// Get CSRF token from cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

$('#submit').click(function(e) {
    e.preventDefault();  // prevent the form from submitting normally

    const commentText = $('#mesg').val();
    const rating = $('input[name="rating"]:checked').val();
    const username = "guest";
    const movieid = new URLSearchParams(window.location.search).get('movietitle');

    if (!commentText || !rating) {
        alert('Please fill in both comment and rating.');
        return;
    }

    const data = {
        mesg: commentText,        // ✅ Matches your model field
        rating: rating,
        movieid: movieid,
        username: username
    };

    $.ajax({
        url: '/api/addusercomment/',
        type: 'POST',
        data: JSON.stringify(data),
        contentType: 'application/json',
        beforeSend: function(xhr) {
            xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
        },
        success: function(response) {
            console.log('Comment added:', response);
            alert('Comment submitted!');
            $('#feedbackForm')[0].reset();
        },
        error: function(xhr, status, error) {
            console.error('Submission error:', xhr.responseText);
            alert('Error submitting comment.');
        }
    });
});


$(document).ready(function () {
    const movieid = new URLSearchParams(window.location.search).get('movietitle');
    console.log('Parsed movie ID:', movieid);

    if (!movieid) {
        alert('Movie ID missing from URL.');
        return;
    }

    const url = `/api/get_comments/${movieid}/`;
    console.log('Fetching from:', url);

    $.ajax({
        url: url,
        type: 'GET',
        success: function(response) {
            console.log('Comments fetched:', response);
            renderComments(response);
        },
        error: function(xhr, status, error) {
    console.error('XHR status:', xhr.status);
    console.error('XHR response:', xhr.responseText);
    console.log('Status:', status);
    console.log('Error:', error);
    alert('Error loading comments. See console for details.');
}
    });

    function renderComments(comments) {
    const commentsList = document.getElementById('commentsList');
    commentsList.innerHTML = '';

    comments.forEach(comment => {
        const rating = parseInt(comment.rating || 0);  // 👈 convert string to number safely

        const div = document.createElement('div');
        div.className = 'comment-item';
        div.innerHTML = `
            <div class="stars">Rating: ${'★'.repeat(rating)}${'☆'.repeat(5 - rating)}</div>
            <p><strong>${comment.username}</strong>: ${comment.mesg}</p>
        `;
        commentsList.appendChild(div);
    });
}
});

</script>




</body>
</html>
